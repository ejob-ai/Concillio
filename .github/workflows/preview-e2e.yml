name: E2E (preview)

permissions:
  contents: read
  checks: write

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches:
      - chore/preview-validation-2025-09-26
  workflow_dispatch:

concurrency:
  group: pages-preview-${{ github.ref }}
  cancel-in-progress: true

jobs:
  preview:
    name: Deploy PR Preview
    runs-on: ubuntu-latest
    outputs:
      pages_url: ${{ steps.resolve_url.outputs.url }}
    steps:
      - uses: actions/checkout@v4

      - name: Locate project root (force repo root)
        id: root
        shell: bash
        run: |
          set -euo pipefail
          echo "root=." >> "$GITHUB_OUTPUT"
          echo "Using repo root as canonical Node project dir"

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: ${{ steps.root.outputs.root }}/package-lock.json

      - name: Install deps & browsers
        working-directory: ${{ steps.root.outputs.root }}
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then npm ci; else npm install; fi
          npx playwright install --with-deps

      - name: Ensure report dirs
        run: mkdir -p junit

        # Playwright behöver sina browsers i CI
      # - name: Skip: browsers already installed
      #   run: echo "Browsers were installed in the previous step"

      - name: Build
        working-directory: ${{ steps.root.outputs.root }}
        run: npm run build

      - name: Publish to Cloudflare Pages
        id: pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken:    ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId:   ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: concillio
          directory:   ${{ steps.root.outputs.root }}/dist
          wranglerVersion: "3.*"

      - name: Resolve preview URL
        id: resolve_url
        run: |
          url="${{ steps.pages.outputs.alias || steps.pages.outputs.url }}"
          # normalisera trailing slash
          url="${url%/}/"
          echo "url=$url" >> "$GITHUB_OUTPUT"

      # OBLIGATORISK för interna PR:er – HEAD + Location-semantik
      - name: Access preflight (HEAD + Location check, preview)
        if: ${{ github.event_name == 'pull_request' && (
                github.event.pull_request.head.repo.full_name == github.repository ||
                github.event.pull_request.head.repo.owner.login == github.repository_owner
             ) }}
        env:
          PREVIEW_URL: ${{ steps.resolve_url.outputs.url }}
        shell: bash
        run: |
          set -euo pipefail
          # Tillåt 301/302/303 -> /cdn-cgi/access/login (absolut eller relativ Location)
          # Hämta ENDAST första svaret (ingen -L)
          read -r code loc_hdr < <(
            curl -sI "$PREVIEW_URL" \
            | awk 'BEGIN{IGNORECASE=1} /^HTTP/{c=$2} /^location:/{l=$2} END{print c, l}' \
            | tr -d "\r"
          )
          if [[ "$code" =~ ^30[123]$ ]] && [[ "$loc_hdr" == *"/cdn-cgi/access/login"* ]]; then
            echo "Access preflight OK (unauthenticated 30x to login)"
          else
            echo "Expected unauthenticated 30x -> /cdn-cgi/access/login, got: $code $loc_hdr"
            exit 1
          fi

          # (valfritt) Auth-probe kan ligga kvar som innan om ni vill
          # read -r code_auth loc_auth <<<"$(
          #   curl -sI "$u" \
          #     -H "CF-Access-Client-Id: ${{ secrets.CF_ACCESS_CLIENT_ID }}" \
          #     -H "CF-Access-Client-Secret: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}" \
          #   | awk 'BEGIN{c="";l=""}/^HTTP\//{c=$2}tolower($1)=="location:"{l=$2}END{printf "%s %s", c, l}'
          # )"
          # [[ "$code_auth" =~ ^20[04]$ || -z "$loc_auth" ]] && echo "Auth OK ($code_auth $loc_auth)" || { echo "Unexpected redirect while authenticated: $code_auth $loc_auth"; exit 1; }

  e2e:
    name: E2E (preview)
    needs: preview
    runs-on: ubuntu-latest
    env:
      # matrix/browser-specific outputs written by our config
      MATRIX_BROWSER: ${{ matrix.browser }}
      JUNIT_FILE: junit/junit-${{ matrix.browser }}.xml
      HTML_DIR: playwright-report-${{ matrix.browser }}
      # preview URLs surfaced by the deploy job
      PREVIEW_URL: ${{ needs.preview.outputs.pages_url }}
      BASE_URL:     ${{ needs.preview.outputs.pages_url }}
      TEST_CONTEXT: "preview"
      # optional Access creds (not required; tests still pass unauthenticated)
      CF_ACCESS_CLIENT_ID:     ${{ secrets.CF_ACCESS_CLIENT_ID }}
      CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}

    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]

    steps:
      - uses: actions/checkout@v4

      - name: Locate project root (force repo root)
        id: root
        shell: bash
        run: |
          set -euo pipefail
          echo "root=." >> "$GITHUB_OUTPUT"
          echo "Using repo root as canonical Node project dir"

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: ${{ steps.root.outputs.root }}/package-lock.json

      - name: Install deps & browsers
        working-directory: ${{ steps.root.outputs.root }}
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then npm ci; else npm install; fi
          npx playwright install --with-deps

      - name: Ensure report dirs
        run: mkdir -p junit

      - name: Debug: check for stray expect copies
        working-directory: ${{ steps.root.outputs.root }}
        run: |
          set -euo pipefail
          echo "== npm ls expect =="
          npm ls expect || true
          echo "== resolve('expect') =="
          node -e "try{console.log(require.resolve('expect'))}catch(e){console.log('no standalone expect')}"

      - name: Run Playwright (preview)
        working-directory: ${{ steps.root.outputs.root }}
        run: |
          set -euo pipefail
          npx playwright test --config="playwright.config.ts" --project="${{ matrix.browser }}"

      - name: Upload JUnit & HTML reports (${{ matrix.browser }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.browser }}
          path: |
            ${{ env.JUNIT_FILE }}
            ${{ env.HTML_DIR }}
          retention-days: 14
          if-no-files-found: warn

      - name: Publish E2E summary (${{ matrix.browser }})
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "### E2E (${{ matrix.browser }})" >> "$GITHUB_STEP_SUMMARY"
          if [ -f "junit/junit-${{ matrix.browser }}.xml" ]; then
            echo "JUnit: junit/junit-${{ matrix.browser }}.xml" >> "$GITHUB_STEP_SUMMARY"
          fi
          if [ -d "playwright-report-${{ matrix.browser }}" ]; then
            echo "HTML report: playwright-report-${{ matrix.browser }}" >> "$GITHUB_STEP_SUMMARY"
          fi

  summary:
    name: E2E (preview) – Summary
    runs-on: ubuntu-latest
    if: always()
    needs:
      - preview
      - e2e
    steps:
      - name: Skriv enkel summering
        shell: bash
        run: |
          echo "### E2E (preview) – sammanfattning" >> "$GITHUB_STEP_SUMMARY"
          echo "- Deploy:  ${{ needs.preview.result }}"  >> "$GITHUB_STEP_SUMMARY"
          echo "- E2E job: ${{ needs.e2e.result }}"      >> "$GITHUB_STEP_SUMMARY"

      - name: Markera fail om matrisen inte var grön
        if: needs.e2e.result != 'success'
        run: |
          echo "::error::E2E matrisen misslyckades (result=${{ needs.e2e.result }})"
          exit 1
