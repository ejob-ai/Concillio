name: E2E (preview)

permissions:
  contents: read
  checks: write

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

concurrency:
  group: pages-preview-v2-${{ github.ref }}
  cancel-in-progress: true

jobs:
  summary_policy:
    name: E2E (preview) – Summary
    if: ${{ github.event_name == 'pull_request' && (github.event.pull_request.head.repo.fork || github.actor == 'dependabot[bot]') }}
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "✅ E2E/preview skipped by policy" >> "$GITHUB_STEP_SUMMARY"
          echo "➡️  Reason: fork or Dependabot PR" >> "$GITHUB_STEP_SUMMARY"
          echo "🔒 No secrets available for this context." >> "$GITHUB_STEP_SUMMARY"

  preview:
    name: Deploy PR Preview (disabled)
    if: false  # disable Wrangler/Pages direct upload; rely on Git-connected Pages preview
    runs-on: ubuntu-latest
    outputs:
      pages_url: ${{ steps.resolve_url.outputs.url }}
    steps:
      - run: echo "Wrangler/Pages deploy disabled (using Git-connected previews)"

          # (valfritt) Auth-probe kan ligga kvar som innan om ni vill
          # read -r code_auth loc_auth <<<"$(
          #   curl -sI "$u" \
          #     -H "CF-Access-Client-Id: ${{ secrets.CF_ACCESS_CLIENT_ID }}" \
          #     -H "CF-Access-Client-Secret: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}" \
          #   | awk 'BEGIN{c="";l=""}/^HTTP\//{c=$2}tolower($1)=="location:"{l=$2}END{printf "%s %s", c, l}'
          # )"
          # [[ "$code_auth" =~ ^20[04]$ || -z "$loc_auth" ]] && echo "Auth OK ($code_auth $loc_auth)" || { echo "Unexpected redirect while authenticated: $code_auth $loc_auth"; exit 1; }

  e2e:
    name: E2E (preview)
    needs: preview
    if: >
      github.event_name != 'pull_request' ||
      (!github.event.pull_request.head.repo.fork && github.actor != 'dependabot[bot]')
    runs-on: ubuntu-latest
    env:
      MATRIX_BROWSER: ${{ matrix.browser }}
      JUNIT_FILE: junit/junit-${{ matrix.browser }}.xml
      HTML_DIR: playwright-report-${{ matrix.browser }}
      # Use Git-connected Pages preview URL pattern; fallback to SMOKE_BASE_URL or prod
      PREVIEW_URL: ${{ vars.PREVIEW_BASE_URL || secrets.PREVIEW_BASE_URL || format('https://{0}-{1}.pages.dev/', github.head_ref, 'concillio') }}
      BASE_URL:     ${{ env.PREVIEW_URL }}
      TEST_CONTEXT: "preview"
      CF_ACCESS_CLIENT_ID:     ${{ secrets.CF_ACCESS_CLIENT_ID }}
      CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}

    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]

    steps:
      - uses: actions/checkout@v5

      - name: Locate project root (force repo root)
        id: root
        shell: bash
        run: |
          set -euo pipefail
          echo "root=." >> "$GITHUB_OUTPUT"
          echo "Using repo root as canonical Node project dir"

      - uses: actions/setup-node@v5
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: ${{ steps.root.outputs.root }}/package-lock.json

      - name: Install deps
        working-directory: ${{ steps.root.outputs.root }}
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then npm ci; else npm install; fi

      # --- Playwright browser cache ---
      - name: Detect Playwright version
        id: pw-version
        working-directory: ${{ steps.root.outputs.root }}
        run: |
          set -euo pipefail
          # 1) Försök läsa installerad playwright-core-version (stabilast för cache)
          ver="$(node -p "try{require('playwright-core/package.json').version}catch(e){''}")"
          # 2) Fallback: package.json (@playwright/test i devDeps/Deps)
          if [ -z "${ver}" ]; then
            ver="$(node -p "try{const p=require('./package.json');(p.devDependencies&&p.devDependencies['@playwright/test'])||(p.dependencies&&p.dependencies['@playwright/test'])||''}catch(e){''}")"
            ver="${ver#^}"; ver="${ver#~}"
          fi
          # 3) Sista fallback: CLI
          if [ -z "${ver}" ]; then
            ver="$(npx --yes playwright --version 2>/dev/null | awk '{print $NF}')"
          fi
          echo "version=${ver:-unknown}" >> "$GITHUB_OUTPUT"

      - name: Cache Playwright browsers
        id: pw-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.pw-version.outputs.version }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright OS deps (always)
        working-directory: ${{ steps.root.outputs.root }}
        run: |
          set -euo pipefail
          npx playwright install-deps

      - name: Install Playwright browsers (on cache miss)
        if: steps.pw-cache.outputs.cache-hit != 'true'
        working-directory: ${{ steps.root.outputs.root }}
        run: |
          set -euo pipefail
          npx playwright install

      - name: Ensure report dirs
        run: mkdir -p junit

      - name: Resolve Git preview URL
        id: git_preview
        shell: bash
        run: |
          set -euo pipefail
          branch="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME}}"
          proj="concillio"
          # Normalize branch to Pages subdomain rules (lowercase, non-alnum -> '-')
          norm=$(echo "$branch" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g')
          url="https://${norm}.${proj}.pages.dev/"
          echo "url=$url" >> "$GITHUB_OUTPUT"

      - name: Run Playwright (preview)
        working-directory: ${{ steps.root.outputs.root }}
        env:
          BASE_URL: ${{ steps.git_preview.outputs.url }}
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
          TEST_LOGIN_TOKEN: ${{ secrets.TEST_LOGIN_TOKEN }}
          TEST_CONTEXT: preview
        run: |
          set -euo pipefail

          rm -rf node_modules/@vitest/expect node_modules/vitest || true

          mkdir -p junit
          npx playwright test --config="playwright.config.ts" --project="${{ matrix.browser }}"

      - name: Upload JUnit & HTML reports (${{ matrix.browser }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.browser }}
          path: |
            ${{ env.JUNIT_FILE }}
            ${{ env.HTML_DIR }}
          retention-days: 7
          if-no-files-found: warn

      - name: Publish E2E summary (${{ matrix.browser }})
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "### E2E (${{ matrix.browser }})" >> "$GITHUB_STEP_SUMMARY"
          if [ -f "junit/junit-${{ matrix.browser }}.xml" ]; then
            echo "JUnit: junit/junit-${{ matrix.browser }}.xml" >> "$GITHUB_STEP_SUMMARY"
          fi
          if [ -d "playwright-report-${{ matrix.browser }}" ]; then
            echo "HTML report: playwright-report-${{ matrix.browser }}" >> "$GITHUB_STEP_SUMMARY"
          fi

  summary:
    name: E2E (preview) – Summary
    needs: [preview, e2e]
    if: >
      always() && needs.preview.result != 'skipped'
    runs-on: ubuntu-latest
    steps:
      - name: Summarize results
        run: |
          echo "## Preview & E2E results" >> $GITHUB_STEP_SUMMARY
          echo "- preview: ${{ needs.preview.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- e2e:     ${{ needs.e2e.result }}"     >> $GITHUB_STEP_SUMMARY
